// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ============= USER MANAGEMENT =============

model User {
  id        String     @id @default(cuid()) @map("_id")
  email     String     @unique
  password  String?
  name      String?
  role      UserRole   @default(UMPIRE)
  
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  deletedAt DateTime?
}

enum UserRole {
  UMPIRE
  VIEWER
  ADMIN
}

// ============= TEAM & PLAYER MANAGEMENT =============

model Team {
  id        String     @id @default(cuid()) @map("_id")
  name      String     @unique
  shortCode String?
  
  players   Player[]
  matches   Match[]    @relation("TeamA")
  matchesB  Match[]    @relation("TeamB")
  
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model Player {
  id        String     @id @default(cuid()) @map("_id")
  name      String
  jerseyNo  Int?
  role      PlayerRole
  
  teamId    String
  team      Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  // Batting stats
  battingStats BattingStats?
  
  // Bowling stats
  bowlingStats BowlingStats?
  
  // Wicket records
  wicketsTaken Wicket[]   @relation("Bowler")
  wicketsLost  Wicket[]   @relation("PlayerOut")
  
  // Fielding
  fieldingStats FieldingStats?
  
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

enum PlayerRole {
  BATSMAN
  BOWLER
  ALL_ROUNDER
  WICKET_KEEPER
}

// ============= MATCH MANAGEMENT =============

model Match {
  id            String     @id @default(cuid()) @map("_id")
  name          String?
  status        MatchStatus @default(NOT_STARTED)
  
  // Teams
  teamAId       String
  teamA         Team       @relation("TeamA", fields: [teamAId], references: [id])
  teamBId       String
  teamB         Team       @relation("TeamB", fields: [teamBId], references: [id])
  
  // Toss details
  tossWinnerId  String?
  tossDecision  TossDecision?
  
  // Match format
  oversLimit    Int        @default(20)
  ballsPerOver  Int        @default(6)
  
  // Playing XI
  playingXI     PlayingXI[]
  
  // Innings
  innings       Innings[]
  
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  
  @@index([teamAId, teamBId])
}

enum MatchStatus {
  NOT_STARTED
  ONGOING
  COMPLETED
  ABANDONED
}

enum TossDecision {
  BAT
  BOWL
}

model PlayingXI {
  id        String     @id @default(cuid()) @map("_id")
  matchId   String
  match     Match      @relation(fields: [matchId], references: [id], onDelete: Cascade)
  
  teamId    String
  playerId  String
  
  createdAt DateTime   @default(now())
  
  @@unique([matchId, teamId, playerId])
}

// ============= INNINGS & SCORING =============

model Innings {
  id            String     @id @default(cuid()) @map("_id")
  matchId       String
  match         Match      @relation(fields: [matchId], references: [id], onDelete: Cascade)
  
  inningsNumber Int        @default(1)
  teamId        String
  
  // Opening players
  openingBatsmanId String
  openingBowlerId String
  
  // Current state
  totalRuns     Int        @default(0)
  totalWickets  Int        @default(0)
  totalBalls    Int        @default(0)
  
  status        InningsStatus @default(NOT_STARTED)
  
  // Overs and balls
  overs         Over[]
  balls         Ball[]
  wickets       Wicket[]
  extras        Extra[]
  
  // Batting and bowling stats per player
  battingInnings BattingStats[]
  bowlingInnings BowlingStats[]
  
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  
  @@unique([matchId, inningsNumber])
  @@index([matchId])
}

enum InningsStatus {
  NOT_STARTED
  ONGOING
  COMPLETED
  ALL_OUT
}

model Over {
  id            String     @id @default(cuid()) @map("_id")
  inningsId     String
  innings       Innings    @relation(fields: [inningsId], references: [id], onDelete: Cascade)
  
  overNumber    Int
  legalBalls    Int        @default(0)
  illegalBalls  Int        @default(0)
  runs          Int        @default(0)
  
  balls         Ball[]
  extras        Extra[]
  
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  
  @@unique([inningsId, overNumber])
}

model Ball {
  id            String     @id @default(cuid()) @map("_id")
  inningsId     String
  innings       Innings    @relation(fields: [inningsId], references: [id], onDelete: Cascade)
  
  overId        String
  over          Over       @relation(fields: [overId], references: [id], onDelete: Cascade)
  
  ballNumber    Int
  
  strikerPlayerId String
  nonStrikerPlayerId String
  bowlerId      String
  
  runs          Int        @default(0)
  isWicket      Boolean    @default(false)
  wicket        Wicket?
  
  ballType      BallType   @default(LEGAL)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  
  @@unique([overId, ballNumber])
  @@index([inningsId])
}

enum BallType {
  LEGAL
  NO_BALL
  WIDE
  BYE
  LEG_BYE
}

model Extra {
  id            String     @id @default(cuid()) @map("_id")
  inningsId     String
  innings       Innings    @relation(fields: [inningsId], references: [id], onDelete: Cascade)
  
  overId        String?
  over          Over?      @relation(fields: [overId], references: [id], onDelete: SetNull)
  
  extraType    ExtraType
  runs          Int
  
  createdAt DateTime   @default(now())
  
  @@index([inningsId])
}

enum ExtraType {
  NO_BALL
  WIDE
  BYE
  LEG_BYE
}

// ============= WICKETS =============

model Wicket {
  id            String     @id @default(cuid()) @map("_id")
  inningsId     String
  innings       Innings    @relation(fields: [inningsId], references: [id], onDelete: Cascade)
  
  ballId        String     @unique
  ball          Ball       @relation(fields: [ballId], references: [id], onDelete: Cascade)
  
  playerOutId   String
  playerOut     Player     @relation("PlayerOut", fields: [playerOutId], references: [id])
  
  bowlerId      String
  bowler        Player     @relation("Bowler", fields: [bowlerId], references: [id])
  
  fielderId     String?
  
  wicketType    WicketType
  
  createdAt DateTime   @default(now())
  
  @@index([inningsId])
}

enum WicketType {
  BOWLED
  CAUGHT
  RUN_OUT
  LBW
  STUMPED
  HIT_WICKET
}

// ============= PLAYER STATISTICS =============

model BattingStats {
  id            String     @id @default(cuid()) @map("_id")
  
  playerId      String     @unique
  player        Player     @relation(fields: [playerId], references: [id], onDelete: Cascade)
  
  inningsId     String?
  innings       Innings?   @relation(fields: [inningsId], references: [id], onDelete: SetNull)
  
  runs          Int        @default(0)
  ballsFaced    Int        @default(0)
  fours         Int        @default(0)
  sixes         Int        @default(0)
  
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model BowlingStats {
  id            String     @id @default(cuid()) @map("_id")
  
  playerId      String     @unique
  player        Player     @relation(fields: [playerId], references: [id], onDelete: Cascade)
  
  inningsId     String?
  innings       Innings?   @relation(fields: [inningsId], references: [id], onDelete: SetNull)
  
  overs         Int        @default(0)
  balls         Int        @default(0)
  runs          Int        @default(0)
  wickets       Int        @default(0)
  
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model FieldingStats {
  id            String     @id @default(cuid()) @map("_id")
  
  playerId      String     @unique
  player        Player     @relation(fields: [playerId], references: [id], onDelete: Cascade)
  
  catches       Int        @default(0)
  runOuts       Int        @default(0)
  stumpings     Int        @default(0)
  
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

// ============= AUDIT LOG =============

model AuditLog {
  id        String     @id @default(cuid()) @map("_id")
  action    String
  userId    String?
  matchId   String?
  details   String?
  
  createdAt DateTime   @default(now())
  
  @@index([matchId, createdAt])
}
